// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// 商品カテゴリー
enum CategoryType {
  Active
  Explorer
  Creative
  Wisdom
  Unique
  Random
}

// 通知タイプ
enum NotificationType {
  chat
  product_stock
}

// チャットの送信タイプ
enum SenderType {
  user
  admin
}

// チャットの内容タイプ
enum SourceType {
  initial
  rule_based
  embedding_search
  staff_confirming
  human_support
  user
}

// 注文状況
enum OrderStatusType {
  pending    // 保留中
  processing // 未発送（発送前）
  shipped    // 発送済み
  delivered  // 配送完了
  cancelled  // キャンセル
  refunded   // 返金済み
}

// サブスクの契約状況
enum SubscriptionContractStatusType {
  active    // 契約中
  cancelled // 解約済み
}

// サブスクの支払い状況
enum SubscriptionStatusType {
  pending   // 保留中
  past_due  // 支払い遅延
  succeeded // 成功時
  failed    // 再試行回数上限に達したためサービス停止（手動による更新が必要）
  canceled  // 解約済み（支払い失敗続きによる自動解約、手動解約など）
}

model User {
  id           String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  lastname     String
  firstname    String
  email        String @unique
  password     String
  emailVerified DateTime? // Auth.jsとの互換性のためキャメルケース
  icon_url     String
  tel          String?
  created_at   DateTime @default(now())
  updated_at   DateTime @default(now()) @updatedAt

  // Relations
  user_stripes    UserStripe?
  reviews    Review[]
  bookmarks  UserBookmark[]
  chat_room ChatRoom?
  orders    Order[]
  subscription_payments SubscriptionPayment[]
  shipping_addresses    ShippingAddress[]
  user_images    UserImage[]
  cart_items CartItem[]

  @@index([email])
  @@index([created_at])
  @@map("users")
}

model UserStripe {
  id            String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id       String @unique @db.Uuid
  customer_id   String
  created_at    DateTime @default(now())
  updated_at    DateTime @default(now()) @updatedAt
  
  // Relations
  user          User @relation(fields: [user_id], references: [id], onDelete: Cascade)
  
  @@index([user_id])
  @@index([customer_id])
  @@map("user_stripes")
}

model Product {
  id           String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title        String
  description  String  @db.VarChar(120) 
  image_urls   String?
  price        Int
  category     CategoryType @default(Active)
  skill_type   String
  slug         String  @unique
  stock        Int     @default(0)
  created_at   DateTime @default(now()) 
  updated_at   DateTime @default(now()) @updatedAt

  // 商品情報
  sync_time          String?
  target_level       String?
  effective_date     String?
  obtainable_skills  String?
  side_effect        String?
  skill_effects      String?
  
  // 関連商品ID
  optimal_syncs_required_id    String?
  optimal_syncs_option_id      String?
  optimal_syncs_recommended_id String?

  optimal_syncs_text  String?  @db.VarChar(60) 

  // Relations
  product_pricings    ProductPricing?
  product_stripes     ProductStripe?
  reviews   Review[]
  bookmarks UserBookmark[]
  order_items OrderItem[]
  cart_items CartItem[]
  
  @@index([price]) 
  @@index([category])
  @@index([stock]) 
  @@index([created_at])
  @@index([category, price])
  @@index([category, stock])
  @@index([category, created_at])
  @@map("products")
}

model ProductPricing {
  id           String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  product_id   String @unique @db.Uuid
  sale_price   Int?
  sold_count   Int      @default(0)
  created_at   DateTime @default(now())
  updated_at   DateTime @default(now()) @updatedAt
  
  // Relations
  product      Product @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@index([sold_count])
  @@map("product_pricings")
}

model ProductStripe {
  id           String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  product_id   String @unique @db.Uuid    // Supabaseの商品ID
  stripe_product_id   String?             // Stripeの商品ID
  regular_price_id   String?              // Stripeの通常商品価格ID
  sale_price_id   String?                 // Stripeのセール商品価格ID
  subscription_price_ids   String?        // Stripeのサブスク商品価格ID
  created_at   DateTime @default(now())
  updated_at   DateTime @default(now()) @updatedAt
  
  // Relations
  product     Product @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@index([stripe_product_id])
  @@map("product_stripes")
}

model CartItem {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    String   @db.Uuid
  product_id String   @db.Uuid
  quantity   Int      @default(1)
  created_at DateTime @default(now())
  updated_at DateTime @default(now()) @updatedAt

  // Relations
  user    User    @relation(fields: [user_id], references: [id], onDelete: Cascade)
  product Product @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@unique([user_id, product_id], name: "user_product_unique")
  @@index([user_id])
  @@index([product_id])
  @@map("cart_items")
}

model Notification {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  type        NotificationType @default(chat)

  notifiable_id   String   // 関連レコードのID
  notifiable_type String   // テーブルの指定

  created_at  DateTime @default(now())
  updated_at  DateTime @default(now()) @updatedAt

  @@index([type])
  @@index([type, created_at])
  @@index([notifiable_id, notifiable_type])
  @@index([notifiable_type]) 
  @@map("notifications")
}

model Review {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id     String?   @db.Uuid
  product_id  String   @db.Uuid
  name        String
  rating      Int      @db.SmallInt
  comment     String
  image_urls  String[] @default([])
  created_at  DateTime @default(now())
  updated_at  DateTime @default(now()) @updatedAt
  is_priority Boolean  @default(false)
  is_approved Boolean  @default(false)

  // Relations
  user    User?    @relation(fields: [user_id], references: [id], onDelete: SetNull)
  product Product @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@index([product_id])
  @@index([user_id])
  @@index([is_approved])
  @@index([is_priority])
  @@index([created_at])
  @@index([product_id, is_approved])
  @@index([product_id, is_priority])
  @@index([is_approved, is_priority])
  @@index([rating])
  @@map("reviews")
}

model ChatRoom {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    String   @unique @db.Uuid
  created_at DateTime @default(now())
  updated_at DateTime @default(now()) @updatedAt

  // Relations
  user  User   @relation(fields: [user_id], references: [id], onDelete: Cascade)
  chats Chat[]

  @@map("chat_rooms")
}

model Chat {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  chat_room_id String   @db.Uuid
  message      String
  sent_at      DateTime @default(now()) 
  sender_type  SenderType @default(user)
  source       SourceType  @default(human_support)
  updated_at   DateTime @default(now()) @updatedAt

  // Relations
  chat_room ChatRoom @relation(fields: [chat_room_id], references: [id], onDelete: Cascade)

  @@index([chat_room_id])
  @@index([sent_at])
  @@map("chats")
}

model Order {
  id                    String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id               String?      @db.Uuid
  order_number          Int         @unique @default(autoincrement())
  status                OrderStatusType @default(pending)
  shipping_fee          Int
  total_amount          Int
  currency              String      @default("jpy")
  address               Json?
  delivery_name         String
  payment_method        String?
  created_at            DateTime    @default(now())
  updated_at            DateTime    @default(now()) @updatedAt
  
  // Relations
  user                  User?        @relation(fields: [user_id], references: [id], onDelete: SetNull)
  order_stripes         OrderStripe?
  order_items           OrderItem[]
  
  @@index([user_id])
  @@index([status])
  @@index([user_id, status])
  @@index([created_at])
  @@map("orders")
}

model OrderStripe {
  id                     String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  order_id               String @unique @db.Uuid
  session_id             String? @unique            // Stripe Checkout Session ID
  payment_intent_id      String? @unique            // Stripe Payment Intent ID
  created_at             DateTime @default(now())
  updated_at             DateTime @default(now()) @updatedAt
  
  // Relations
  order                  Order @relation(fields: [order_id], references: [id], onDelete: Cascade)

  @@index([session_id])
  @@index([payment_intent_id])
  @@map("order_stripes")
}

model OrderItem {
  id                    String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  order_id              String   @db.Uuid
  product_id            String   @db.Uuid
  quantity              Int
  unit_price            Int      // 購入時の単価
  total_price           Int      // 単価×数量
  stripe_price_id       String?  // 使用Stripe価格ID
  remarks               String?  // 備考テキスト
  subscription_id       String?  @unique  // Stripe subscription ID
  subscription_status   SubscriptionContractStatusType?
  subscription_interval String?  // サブスクの周期
  subscription_next_payment DateTime?  // サブスクの次回支払日
  created_at            DateTime @default(now())
  updated_at            DateTime @default(now()) @updatedAt
  
  // Relations
  order                 Order    @relation(fields: [order_id], references: [id], onDelete: Cascade)
  product               Product  @relation(fields: [product_id], references: [id], onDelete: Restrict)
  subscriptionPayments  SubscriptionPayment[] @relation("OrderItemSubscriptionPayment")
  
  @@index([order_id])
  @@index([product_id])
  @@index([product_id, subscription_id, subscription_status])
  @@index([subscription_id])
  @@index([subscription_status])
  @@index([order_id, product_id])
  @@index([created_at])
  @@map("order_items")
}

model SubscriptionPayment {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id         String?   @db.Uuid
  payment_date    DateTime
  status          SubscriptionStatusType   @default(pending)
  subscription_id String   // Stripe subscription ID
  created_at      DateTime @default(now())
  updated_at      DateTime @default(now()) @updatedAt

  user User? @relation(fields: [user_id], references: [id], onDelete: SetNull)
  orderItem OrderItem? @relation("OrderItemSubscriptionPayment", fields: [subscription_id], references: [subscription_id], onDelete: Cascade)

  @@index([user_id])
  @@index([subscription_id])
  @@index([status])
  @@index([payment_date])
  @@index([created_at])
  @@index([user_id, status])
  @@index([subscription_id, status])
  @@map("subscription_payments")
}

model ShippingAddress {
  id                    String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id               String      @db.Uuid
  name                  String      // 受取人名
  postal_code           String
  state                 String
  city                  String?
  address_line1         String
  address_line2         String?
  is_default            Boolean     @default(false)
  created_at            DateTime    @default(now())
  updated_at            DateTime    @default(now()) @updatedAt
  
  // Relations
  user                  User        @relation(fields: [user_id], references: [id], onDelete: Cascade)
  
  @@index([user_id])
  @@map("shipping_addresses")
}

// ユーザーのアイコン画像のファイルパス参照用
model UserImage {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id         String   @unique @db.Uuid
  file_path       String?  @unique
  created_at      DateTime @default(now())
  updated_at      DateTime @default(now()) @updatedAt

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@map("user_images")
}

// ユーザーのブックマーク（中間テーブル）
model UserBookmark {
  user_id    String   @db.Uuid
  product_id String   @db.Uuid
  created_at DateTime @default(now())
  updated_at DateTime @default(now()) @updatedAt

  // Relations
  user    User    @relation(fields: [user_id], references: [id], onDelete: Cascade)
  product Product @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@id([user_id, product_id]) // 同じユーザーが同じ商品を複数回ブックマークできないように
  @@index([user_id])
  @@index([product_id])
  @@map("user_bookmarks")
}
 
model VerificationToken {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  identifier String
  token      String   @unique
  expires    DateTime
  password   String?
  userData   String?   // Auth.jsとの互換性のためキャメルケース
  created_at  DateTime @default(now())
  updated_at  DateTime @default(now()) @updatedAt
 
  @@unique([identifier, token])
  @@map("verification_tokens")
}